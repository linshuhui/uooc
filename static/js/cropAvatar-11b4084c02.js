!function(){function t(t,a){this.name=a,this.$container=t,this.$avatarView=this.$container.find(".avatar-view").eq(0),this.$avatar=this.$avatarView.find("img"),this.$avatarModal=this.$container.find(".avatar-modal").eq(0),this.$loading=this.$container.find(".loading"),this.$avatarForm=this.$avatarModal.find(".avatar-form"),this.$avatarUpload=this.$avatarForm.find(".avatar-upload"),this.$avatarSrc=this.$avatarForm.find(".avatar-src"),this.$avatarData=this.$avatarForm.find(".avatar-data"),this.$avatarInput=this.$avatarForm.find(".avatar-input"),this.$avatarBtns=this.$avatarForm.find(".avatar-btns"),this.$avatarWrapper=this.$avatarModal.find(".avatar-wrapper"),this.$avatarPreview=this.$avatarModal.find(".avatar-preview"),this.init()}t.prototype={constructor:t,support:{fileList:!!$('<input type="file">').prop("files"),blobURLs:!!window.URL&&URL.createObjectURL,formData:!!window.FormData},init:function(){this.support.datauri=this.support.fileList&&this.support.blobURLs,this.support.formData||this.initIframe(),this.addListener()},addListener:function(){this.$avatarView.on("click",$.proxy(this.click,this)),this.$avatarInput.on("change",$.proxy(this.change,this)),this.$avatarForm.on("submit",$.proxy(this.submit,this)),this.$avatarBtns.on("click",$.proxy(this.rotate,this))},initPreview:function(){var t=this.$avatar.attr("src");this.$avatarPreview.html('<img src="'+t+'">')},initIframe:function(){var t="upload-iframe-"+(new Date).getTime(),a=$("<iframe>").attr({name:t,src:""}),i=this;a.one("load",function(){a.on("load",function(){var t;try{t=$(this).contents().find("body").text()}catch(a){console.log(a.message)}if(t){try{t=$.parseJSON(t)}catch(a){console.log(a.message)}i.submitDone(t)}else i.submitFail("上传失败!");i.submitEnd()})}),this.$iframe=a,this.$avatarForm.attr("target",t).after(a.hide())},submit:function(){return this.$img||this.$avatarSrc.val()||this.$avatarInput.val()?this.support.formData?(this.uploadBefore(),!1):(this.$avatarForm[0].submit(),!1):(this.alert("文件格式不支持"),!1)},submitDone:function(t){$.isPlainObject(t)&&200===t.state?t.result?(this.url=t.result,this.support.datauri||this.uploaded?(this.uploaded=!1,this.cropDone()):(this.uploaded=!0,this.$avatarSrc.val(this.url),this.startCropper()),this.$avatarInput.val("")):t.message&&this.alert(t.message):this.alert("Failed to response")},submitFail:function(t){layer.msg(t||"上传失败"),this.$loading.hide()},submitEnd:function(){this.$loading.fadeOut()},click:function(){this.$avatarModal.modal("show"),this.initPreview()},change:function(){var t,a;this.support.datauri?(t=this.$avatarInput.prop("files"),t.length>0&&(a=t[0],this.isImageFile(a)&&(this.url&&URL.revokeObjectURL(this.url),this.url=URL.createObjectURL(a),this.file=a,this.startCropper()))):(a=this.$avatarInput.val(),this.isImageFile(a)&&this.syncUpload())},rotate:function(t){var a;this.active&&(a=$(t.target).data(),a.method&&this.$img.cropper(a.method,a.option))},isImageFile:function(t){return t.type?/^image\/\w+$/.test(t.type):/\.(jpg|jpeg|png|gif)$/.test(t)},isAvalidname:function(t){var a=t.replace(/(.*\/)*([^.]+).*/gi,"$2"),i=/[\~\!\/\#\$\%\^\*\=\+\\\|\[\{\}\]\;\:\'\"\<\>\/\?]+/gi;return i.test(a)},startCropper:function(){this.params=this.params||{},this.url=this.url||window.staticRoot+"/index/images/user_default.jpg";var t=this,a=$.extend({aspectRatio:this.params.aspectRatio||1,dragMode:"move",viewMode:1,preview:this.$avatarPreview.selector,crop:function(a){var i=['{"x":'+a.x,'"y":'+a.y,'"height":'+a.height,'"width":'+a.width,'"rotate":'+a.rotate+"}"].join();t.$avatarData.val(i)}},this.params);this.active?this.$img.cropper("replace",this.url):(this.$img=$('<img src="'+this.url+'">'),this.$avatarWrapper.empty().html(this.$img),this.$img.cropper(a),this.active=!0),this.$avatarModal.one("hidden.bs.modal",function(){t.$avatarPreview.empty(),t.stopCropper()})},stopCropper:function(){layer.close(a),this.active&&(this.$img.cropper("destroy"),this.$img.remove(),this.active=!1)},canvasBlobSupport:function(){var t=document.createElement("canvas");return!!t.getContext&&!!t.toBlob},uploadBefore:function(){var t=this,a=this.$img[0].width,i=(a>800?800:a)||400,e=parseInt(i/(this.params.aspectRatio||1)),r=new FormData(this.$avatarForm[0]),s=t.$img.attr("src"),o=s.replace(/(.*\/)*([^.]+).*/gi,"$2"),n=this.$avatarInput.val();if(n&&!this.isImageFile(n))return void this.submitFail("文件格式不支持");if(n&&this.isAvalidname(this.file.name))return void this.submitFail("上传图片文件名不能包含特殊字符");if(r.append("type",t.params.type||"user"),r.append("cid",t.params.cid||""),t.canvasBlobSupport())t.$img.cropper("getCroppedCanvas",{width:i,height:e}).toBlob(function(a){r["delete"]("file"),r.append("file",a,o+".png"),t.ajaxUpload(r)});else{if(!this.isImageFile(n))return void this.submitFail("请选择一张图片");r.append("crop",1),t.ajaxUpload(r)}},ajaxUpload:function(t){var a=this;$.ajax("/upload/index",{type:"post",data:t,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){a.submitStart()},success:function(t){a.submitDone(t)},error:function(t,i,e){a.submitFail(i||e)},complete:function(){a.submitEnd()}})},submitStart:function(){this.$loading.fadeIn()},submitDone:function(t){$.isPlainObject(t)&&1==t.code?t.data?(this.url=t.data.url,this.support.datauri||this.uploaded?(this.uploaded=!1,this.cropDone()):(this.uploaded=!0,this.$avatarSrc.val(this.url),this.startCropper()),$("#cropperVal").val(this.url),this.$avatarInput.val(""),this.params.done&&this.params.done(t,this.url)):data.message&&this.alert(t.message):this.alert("上传失败"+t.msg)},cropDone:function(){this.$avatarForm.get(0).reset(),this.$avatar.attr("src",this.url),this.stopCropper()},alert:function(t,a){var i=this;this.timer&&clearTimeout(this.timer),this.$loading.html(t).fadeIn(),a&&(this.timer=setTimeout(function(){i.$loading.html(t).fadeOut()},a))}};var a;app.directive("cropAvatar",["uoocService","courseService","$timeout",function(i,e,r){return{restrict:"AE",scope:{options:"=",onsave:"&",ename:"@"},templateUrl:"/tpl/directive/crop.avatar.html",link:function(i,e,r){var s=i.options||{};i.dateKey=(new Date).getTime();var o=(s.cid||1163945558,s.prefix||"avatar/",new t(angular.element(e),i.ename));i.hasLayer=!1,i.layerCrop=function(){i.hasLayer=!0,a=layer.open({type:1,title:!1,shadeClose:!1,closeBtn:0,scrollbar:!1,skin:"layui-layer-rim",area:["742px","540px"],content:e.find(".avatar-crop"),end:function(){i.hasLayer=!1}})},i.closeCrop=function(){layer.close(a)},i.$on(i.ename||"layerCrop",function(t){if(!i.hasLayer){var a=o.canvasBlobSupport()?t.url||i.options.url:window.staticRoot+"/index/images/user_default.jpg";o.url=a,o.aspectRatio=t.aspectRatio||i.options.aspectRatio||1,o.params={url:a,aspectRatio:t.aspectRatio||i.options.aspectRatio||1,type:i.options.type||"common",cid:i.options.cid||"",done:function(t,a){i.options.url=a,i.onsave&&i.onsave(),i.$apply()}},o.startCropper(),i.layerCrop()}}),o.$loading.hide(),i.savePic=function(){o.submit()}}}}])}();